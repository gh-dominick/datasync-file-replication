sys_path: ./
namespace: ${customer}-${environment}
stacker_bucket: ${customer}-${environment}-${region}-stacker

common_parameters: &common_parameters
  CustomerName: ${customer}
  EnvironmentName: ${environment}
  VpcId: ${vpc_id}
  Subnet1: ${subnet1}
  Subnet2: ${subnet2}
  SshKey: ${ssh_key_name}

stacks:
  datasync-agent-sg:
    template_path: templates/security-group.yaml
    variables:
      << : *common_parameters
      ApplicationName: datasync-agent
  datasync-sg-https-ingress:
    template_path: templates/security-group-ingress.yaml
    variables:
      FromPort: 443
      ToPort: 443
      IpProtocol: tcp
      GroupId: ${output datasync-agent-sg::SecurityGroup}
      CidrIp: ${vpc_cidr}
  datasync-agent-destination-nfs-ingress:
    template_path: templates/security-group-ingress.yaml
    variables:
      FromPort: 2049
      ToPort: 2049
      IpProtocol: tcp
      GroupId: ${rxref datasync-efs-destination::EfsServerSecurityGroup}
      SourceSecurityGroupId: ${output datasync-agent-sg::SecurityGroup}
  datasync-vpce-sg:
    template_path: templates/security-group.yaml
    variables:
      << : *common_parameters
      ApplicationName: datasync-vpc-endpoint
  datasync-agent-https-ingress:
    template_path: templates/security-group-ingress.yaml
    variables:
      FromPort: 443
      ToPort: 443
      IpProtocol: tcp
      GroupId: ${output datasync-vpce-sg::SecurityGroup}
      SourceSecurityGroupId: ${output datasync-agent-sg::SecurityGroup}
  datasync-agent-ingress:
    template_path: templates/security-group-ingress.yaml
    variables:
      FromPort: 1024
      ToPort: 1064
      IpProtocol: tcp
      GroupId: ${output datasync-vpce-sg::SecurityGroup}
      SourceSecurityGroupId: ${output datasync-agent-sg::SecurityGroup}
  datasync-vpc-endpoint:
    template_path: templates/vpc-endpoint.yaml
    variables:
      << : *common_parameters
      ApplicationName: datasync
      EndpointService: datasync
      SubnetIds: ${subnet1},${subnet2}
      SecurityGroupIds: ${output datasync-vpce-sg::SecurityGroup}
      VpcEndpointType: Interface
  datasync-agent:
    template_path: templates/datasync-agent-asg.yaml
    variables:
      << : *common_parameters
      ApplicationName: datasync-agent
      AgentSecurityGroup: ${output datasync-agent-sg::SecurityGroup}
      AllServerSecurityGroup: ${all_server_security_group}
      EfsClientSecurityGroup: ${rxref datasync-efs-source::EfsClientSecurityGroup}
      DestinationEfsIp: ${rxref datasync-efs-destination::EfsMountTargetIp1}
      SourceLocationRegion: ${region}
      SourceEfsFilesystemId: ${rxref datasync-efs-source::EfsId}
      SourceSubnetId: ${subnet1}
      SyncTaskCronSchedule: '05 * * * ? *'
      VpcEndpoint: ${output datasync-vpc-endpoint::DataSyncVpcInterfaceEndpointId}
      VpcEndpointSecurityGroupId: ${output datasync-vpce-sg::SecurityGroup}
      PrivateLinkEndpointIp: ${private_link_endpoint_ip}
